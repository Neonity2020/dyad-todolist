# 子任务同步功能测试指南

## 测试目标

验证子任务的所有操作（创建、编辑、删除、状态切换）都能正确触发同步按钮显示，并成功同步到数据库。

## 测试步骤

### 1. 测试子任务创建

1. **打开应用**：启动开发服务器 `pnpm dev`
2. **登录账户**：使用有效的用户账户登录
3. **创建待办事项**：先创建一个主任务
4. **添加子任务**：
   - 点击主任务的展开按钮
   - 在子任务输入框中输入文本
   - 点击添加按钮或按回车

**预期结果**：
- ✅ 子任务立即显示在列表中
- ✅ 同步按钮出现，显示待同步操作数量
- ✅ 同步状态指示器显示待同步信息

### 2. 测试子任务编辑

1. **编辑子任务**：
   - 点击子任务文本进入编辑模式
   - 修改文本内容
   - 按回车或点击其他地方保存

**预期结果**：
- ✅ 子任务文本立即更新
- ✅ 同步队列中增加更新操作
- ✅ 同步按钮显示更新后的操作数量

### 3. 测试子任务状态切换

1. **切换完成状态**：
   - 点击子任务前的复选框
   - 观察状态变化

**预期结果**：
- ✅ 复选框状态立即改变
- ✅ 同步队列中增加更新操作
- ✅ 同步按钮显示待同步操作

### 4. 测试子任务删除

1. **删除子任务**：
   - 点击子任务右侧的删除按钮
   - 确认删除操作

**预期结果**：
- ✅ 子任务立即从列表中消失
- ✅ 同步队列中增加删除操作
- ✅ 同步按钮显示待同步操作

### 5. 测试批量操作

1. **连续操作**：
   - 快速创建多个子任务
   - 编辑几个子任务
   - 删除几个子任务
   - 切换几个子任务状态

**预期结果**：
- ✅ 所有操作立即响应
- ✅ 同步队列累积所有操作
- ✅ 同步按钮显示总操作数量

### 6. 测试同步功能

1. **点击同步按钮**：
   - 等待同步完成
   - 观察同步状态

**预期结果**：
- ✅ 同步过程中按钮显示加载状态
- ✅ 同步完成后操作数量归零
- ✅ 同步按钮消失
- ✅ 显示上次同步时间

### 7. 测试强制同步

1. **模拟同步失败**：
   - 断开网络连接
   - 尝试同步操作
   - 使用强制同步

**预期结果**：
- ✅ 强制同步清空操作队列
- ✅ 重新加载数据库数据
- ✅ 界面状态与数据库一致

## 故障排除

### 问题 1：同步按钮不显示

**可能原因**：
- 子任务操作没有正确添加到同步队列
- 类型转换问题
- 状态更新失败

**检查步骤**：
1. 打开浏览器控制台
2. 查看是否有错误信息
3. 检查 `pendingOperations` 状态
4. 验证 `addToSyncQueue` 调用

### 问题 2：子任务操作失败

**可能原因**：
- 字段映射错误
- 数据库约束问题
- 网络连接问题

**检查步骤**：
1. 检查数据库表结构
2. 验证字段名映射
3. 查看网络请求状态
4. 检查 RLS 策略

### 问题 3：同步后数据不一致

**可能原因**：
- 同步逻辑错误
- ID 更新失败
- 状态管理问题

**检查步骤**：
1. 刷新页面验证数据
2. 检查数据库中的实际数据
3. 查看同步日志
4. 验证本地状态更新

## 调试技巧

### 1. 控制台日志

```typescript
// 在 useTodos Hook 中添加更多日志
console.log('Subtask operation added to sync queue:', operation);
console.log('Current pending operations:', pendingOperations);
console.log('Sync started with operations:', operations);
```

### 2. 状态检查

```typescript
// 在组件中添加状态显示
console.log('Current todos state:', todos);
console.log('Pending operations:', pendingOperations);
console.log('Sync status:', { syncing, hasPendingChanges });
```

### 3. 网络监控

- 使用浏览器开发者工具的网络面板
- 监控 Supabase API 请求
- 检查请求和响应数据

## 预期结果总结

完成所有测试后，您应该看到：

✅ **子任务创建**：立即显示，触发同步
✅ **子任务编辑**：实时更新，加入队列
✅ **状态切换**：即时响应，等待同步
✅ **子任务删除**：立即移除，同步删除
✅ **批量操作**：累积操作，统一同步
✅ **同步功能**：成功同步，状态一致
✅ **错误处理**：支持重试，强制同步

## 下一步

如果测试成功，您可以：
1. 继续测试其他功能
2. 优化用户体验
3. 添加更多子任务特性
4. 部署到生产环境

如果遇到问题，请：
1. 检查错误日志
2. 验证数据库配置
3. 测试网络连接
4. 联系技术支持
